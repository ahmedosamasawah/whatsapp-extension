{"version":3,"file":"background.js","sources":["../../src/background/background.js"],"sourcesContent":["// Background script for WhatsApp AI Transcriber\n\n// Listen for extension installation or update\nchrome.runtime.onInstalled.addListener((details) => {\n  if (details.reason === \"install\") {\n    // Open options page on install\n    chrome.runtime.openOptionsPage();\n  }\n});\n\n// Listen for messages from content scripts or popup\nchrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\n  console.log(\"Background received message:\", message.action);\n\n  // Handle opening options page\n  if (message.action === \"openOptionsPage\") {\n    chrome.runtime.openOptionsPage();\n    sendResponse({ success: true });\n  }\n\n  // Handle API key verification\n  if (message.action === \"verifyApiKey\") {\n    verifyApiKey(message.apiKey)\n      .then((result) => {\n        if (result.valid) {\n          // Save to both sync and local storage\n          chrome.storage.sync.set({ openai_api_key: message.apiKey });\n          chrome.storage.local.set({ openai_api_key: message.apiKey });\n          console.log(\"API key saved to both sync and local storage\");\n        }\n        sendResponse(result);\n      })\n      .catch((error) => sendResponse({ valid: false, error: error.message }));\n\n    return true; // Keep channel open for async response\n  }\n\n  // Add a diagnostic message handler to check storage directly\n  if (message.action === \"checkStorage\") {\n    console.log(\"Checking storage contents...\");\n    chrome.storage.sync.get(null, function (syncItems) {\n      console.log(\"Sync storage items:\", syncItems);\n      chrome.storage.local.get(null, function (localItems) {\n        console.log(\"Local storage items:\", localItems);\n        sendResponse({\n          syncStorage: syncItems,\n          localStorage: localItems,\n        });\n      });\n    });\n    return true; // Keep channel open for async response\n  }\n\n  // Return API key directly to content script\n  if (message.action === \"getApiKey\") {\n    console.log(\"Getting API key from storage...\");\n    chrome.storage.local.get([\"openai_api_key\"], function (localItems) {\n      if (localItems.openai_api_key) {\n        console.log(\"Found API key in local storage\");\n        sendResponse({ apiKey: localItems.openai_api_key });\n      } else {\n        chrome.storage.sync.get([\"openai_api_key\"], function (syncItems) {\n          if (syncItems.openai_api_key) {\n            console.log(\"Found API key in sync storage, copying to local\");\n            chrome.storage.local.set({\n              openai_api_key: syncItems.openai_api_key,\n            });\n            sendResponse({ apiKey: syncItems.openai_api_key });\n          } else {\n            console.log(\"No API key found in either storage\");\n            sendResponse({ apiKey: null });\n          }\n        });\n      }\n    });\n    return true; // Keep channel open for async response\n  }\n\n  // Handle settings update notification\n  if (message.action === \"settingsUpdated\") {\n    console.log(\"Settings updated, notifying tabs\");\n    // Notify all WhatsApp tabs about the change\n    chrome.tabs.query({ url: \"https://web.whatsapp.com/*\" }, (tabs) => {\n      tabs.forEach((tab) => {\n        chrome.tabs.sendMessage(tab.id, { action: \"settingsUpdated\" });\n      });\n    });\n\n    sendResponse({ success: true });\n  }\n});\n\n/**\n * Verify if an OpenAI API key is valid\n * @param {string} apiKey - The API key to verify\n * @returns {Promise<Object>} - Results of the verification\n */\nasync function verifyApiKey(apiKey) {\n  if (!apiKey) {\n    return { valid: false, error: \"API key is empty\" };\n  }\n\n  if (!apiKey.startsWith(\"sk-\")) {\n    return { valid: false, error: \"Invalid API key format\" };\n  }\n\n  try {\n    // Make a lightweight request to OpenAI to check if the key is valid\n    const response = await fetch(\"https://api.openai.com/v1/models\", {\n      method: \"GET\",\n      headers: {\n        Authorization: `Bearer ${apiKey}`,\n        \"Content-Type\": \"application/json\",\n      },\n    });\n\n    if (!response.ok) {\n      const error = await response.json();\n      return { valid: false, error: error.error.message || \"Invalid API key\" };\n    }\n\n    return { valid: true };\n  } catch (error) {\n    return { valid: false, error: error.message || \"Network error\" };\n  }\n}\n\n// When the background script loads, check sync storage for API key and copy to local\nchrome.storage.sync.get([\"openai_api_key\"], function (result) {\n  if (result.openai_api_key) {\n    console.log(\"Found API key in sync storage, copying to local storage\");\n    chrome.storage.local.set({ openai_api_key: result.openai_api_key });\n  }\n});\n"],"names":[],"mappings":"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"}